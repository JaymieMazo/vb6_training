<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />
<meta http-equiv="Content-Language" content="en" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<meta name="robots" content="all" scheme="http://www.robotstxt.org/" />
<meta name="generator" content="Oracle DARB XHTML Converter (Mode = document) - Version 5.1.1 Build 026" />
<meta name="Date" content="2010-01-21T17:30:13Z" />
<meta name="doctitle" content="Oracle&reg; Services for Microsoft Transaction Server Developer's Guide 11g Release 2 (11.2) for Microsoft Windows" />
<meta name="partno" content="E12247-01" />
<meta name="docid" content="NTMTS" />
<link rel="Start" href="../../index.htm" title="Home" type="text/html" />
<link rel="Copyright" href="../../dcommon/html/cpyr.htm" title="Copyright" type="text/html" />
<link rel="Stylesheet" href="../../dcommon/css/blafdoc.css" title="Default" type="text/css" />
<script type="text/javascript" src="../../dcommon/js/doccd.js">
</script>
<link rel="Contents" href="toc.htm" title="Contents" type="text/html" />
<link rel="Index" href="index.htm" title="Index" type="text/html" />
<link rel="Glossary" href="glossary.htm" title="Glossary" type="text/html" />
<link rel="Prev" href="recovery.htm" title="Previous" type="text/html" />
<link rel="Next" href="perftune.htm" title="Next" type="text/html" />
<link rel="alternate" href="../e12247.pdf" title="PDF version" type="application/pdf" />
<title>Programming with Microsoft Transaction Server and an Oracle Database</title>
</head>
<body>
<div class="header">
<div class="zz-skip-header"><a name="top" id="top" href="#BEGIN">Skip Headers</a></div>
<table class="simple oac_no_warn" summary="" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td align="left" valign="top"><b>Oracle&reg; Services for Microsoft Transaction Server Developer's Guide<br />
11<i>g</i> Release 2 (11.2) for Microsoft Windows</b><br />
Part Number E12247-01</td>
<td valign="bottom" align="right">
<table class="icons oac_no_warn" summary="" cellspacing="0" cellpadding="0" width="245">
<tr>
<td align="center" valign="top"><a href="../../index.htm"><img width="24" height="24" src="../../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td align="center" valign="top"><a href="../../nav/portal_booklist.htm"><img width="24" height="24" src="../../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td align="center" valign="top"><a href="toc.htm"><img width="24" height="24" src="../../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td align="center" valign="top"><a href="index.htm"><img width="24" height="24" src="../../dcommon/gifs/index.gif" alt="Go to Index" /><br />
<span class="icon">Index</span></a></td>
<td align="center" valign="top"><a href="../../dcommon/html/feedback.htm"><img width="24" height="24" src="../../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
<hr />
<table class="simple oac_no_warn" summary="" cellspacing="0" cellpadding="0" width="100%">
<tr>
<td align="left" valign="top">
<table class="simple oac_no_warn" summary="" cellspacing="0" cellpadding="0" width="98">
<tr>
<td align="center" valign="top"><a href="recovery.htm"><img width="24" height="24" src="../../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td align="center" valign="top"><a href="perftune.htm"><img width="24" height="24" src="../../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td align="right" valign="top" style="font-size: 90%"><a href="../e12247.pdf">View PDF</a></td>
</tr>
</table>
<a name="BEGIN" id="BEGIN"></a></div>
<div class="IND"><!-- End Header --><a id="BEJCGIDB" name="BEJCGIDB"></a><a id="NTMTS005" name="NTMTS005"></a>
<h1 class="chapter"><span class="secnum">4</span> Programming with Microsoft Transaction Server and an Oracle Database</h1>
<p>This chapter describes how to program with <a href="glossary.htm#CBAIJAFH"><span class="xrefglossterm">Microsoft Transaction Server</span></a> and an Oracle Database.</p>
<p>This chapter contains these topics:</p>
<ul>
<li>
<p><a href="#BEJCGBGG">COM Component Integration in a Transaction</a></p>
</li>
<li>
<p><a href="#i1006362">Microsoft Transaction Server Application Development</a></p>
</li>
<li>
<p><a href="#i1006563">OCI Integration with Microsoft Transaction Server</a></p>
</li>
<li>
<p><a href="#i1007399">ODBC Integration with Microsoft Transaction Server Overview</a></p>
</li>
</ul>
<p>OraMTS also provides integration with OO4O, Oracle Provider for OLE DB, and Oracle Data Provider for .NET.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a class="olink OOFOL" href="http://www.oracle.com/pls/db102/lookup?id=OOFOL"><span class="italic">Oracle Objects for OLE Developer's Guide</span></a> for information on using OO4O with MTS</p>
</li>
<li>
<p><a class="olink OLEDB" href="http://www.oracle.com/pls/db102/lookup?id=OLEDB"><span class="italic">Oracle Provider for OLE DB Developer's Guide</span></a> for information on using Oracle Provider for OLE DB with MTS</p>
</li>
<li>
<p><a class="olink ODPNT" href="http://www.oracle.com/pls/db102/lookup?id=ODPNT"><span class="italic">Oracle Data Provider for .NET Developer's Guide</span></a> for information on using Oracle Data Provider for .NET with MTS</p>
</li>
</ul>
</div>
<a id="BEJCGBGG" name="BEJCGBGG"></a><a id="NTMTS159" name="NTMTS159"></a>
<div class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1">COM Component Integration in a Transaction</h2>
<p>The focal point of the transaction process is a component of Microsoft Transaction Server called <a href="glossary.htm#CBAFFEFA"><span class="xrefglossterm">Microsoft Distributed Transaction Coordinator (MS DTC)</span></a>. When a client computer starts a business method on a transactional component, Microsoft Transaction Server begins a transaction coordinated by the MS DTC. The Oracle connection pooling layer enables the database to act as a <a href="glossary.htm#CBAGDBEA"><span class="xrefglossterm">resource manager (RM)</span></a> in the MS DTC-coordinated transaction. <a href="#BEJCBEED">Figure 4-1</a> illustrates this transactional model.</p>
<div class="figure"><a id="BEJCBEED" name="BEJCBEED"></a><a id="NTMTS160" name="NTMTS160"></a>
<p class="titleinfigure">Figure 4-1 Component Integration in a Transaction</p>
<img width="491" height="506" src="img/ntmts011.gif" alt="Description of Figure 4-1 follows" title="Description of Figure 4-1 follows" longdesc="img_text/ntmts011.htm" /><br />
<a id="sthref127" name="sthref127" href="img_text/ntmts011.htm">Description of "Figure 4-1 Component Integration in a Transaction"</a><br />
<br /></div>
<!-- class="figure" -->
<a id="NTMTS161" name="NTMTS161"></a><a id="sthref128" name="sthref128"></a>
<p><span class="subhead3">Client Computer&nbsp;</span>The client computer activates the application components on the <a href="#BEJGHEGI">MTS Application Server</a> through a Web browser or through the <a href="glossary.htm#CBACFAIF"><span class="xrefglossterm">component object model (COM)</span></a> /<a href="glossary.htm#CBAIHGDA"><span class="xrefglossterm">distributed component object model (DCOM)</span></a>.</p>
<a id="BEJGHEGI" name="BEJGHEGI"></a><a id="NTMTS162" name="NTMTS162"></a>
<p><span class="subhead3">MTS Application Server&nbsp;</span>The MTS application server is composed of the transaction client computer activates the application components through a Web browser or through the <a href="glossary.htm#CBACFAIF"><span class="xrefglossterm">component object model (COM)</span></a> /<a href="glossary.htm#CBAIHGDA"><span class="xrefglossterm">distributed component object model (DCOM)</span></a>.</p>
<a id="NTMTS163" name="NTMTS163"></a><a id="sthref129" name="sthref129"></a>
<p><span class="subhead3">Transactional Application Logic COM Components&nbsp;</span>Three primary responsibilities:</p>
<ul>
<li>
<p>Embed the business logic. If a component is transactional, Microsoft Transaction Server starts a transaction for every method invocation on that component.</p>
</li>
<li>
<p>Acquire pooled connections to a Oracle Database through the Oracle resource dispenser and <a href="glossary.htm#CBAEGJCG"><span class="xrefglossterm">Oracle Call Interface (OCI)</span></a>, <a href="glossary.htm#CBACJCBG"><span class="xrefglossterm">Oracle Open Database Connectivity (ODBC) Driver</span></a>, <a href="glossary.htm#CBAHFGAI"><span class="xrefglossterm">Oracle Provider for OLE DB</span></a>, or <a href="glossary.htm#g997613"><span class="xrefglossterm"><span class="bold">Oracle Objects for OLE (OO4O)</span></span></a>.</p>
</li>
<li>
<p>Decide the outcome of the operation by notifying Microsoft Transaction Server of its decision to commit or terminate the changes to all RMs.</p>
</li>
</ul>
<a id="NTMTS164" name="NTMTS164"></a><a id="sthref130" name="sthref130"></a>
<p><span class="subhead3">Oracle ODBC Driver, OO4O, Oracle Provider for OLE DB, and OCI&nbsp;</span>Two primary responsibilities:</p>
<ul>
<li>
<p>Obtain a service context to the Oracle Database through the OCI connection pooling component.</p>
</li>
<li>
<p>Provide connection pooling resources, if necessary (through Oracle Provider for OLE DB or Oracle ODBC Driver). The Oracle ODBC Driver provides pooled ODBC connections. Oracle Provider for OLE DB provides pooled data source objects. OO4O uses the OCI connection pool.</p>
</li>
</ul>
<a id="NTMTS165" name="NTMTS165"></a><a id="sthref131" name="sthref131"></a>
<p><span class="subhead3">OCI Connection Pool&nbsp;</span>Three primary responsibilities:</p>
<ul>
<li>
<p>Enlists the RM (Oracle Database) in the component's Microsoft Transaction Server transaction.</p>
</li>
<li>
<p>Starts an Oracle global transaction corresponding to the Microsoft Transaction Server transaction of which the component is a part.</p>
</li>
<li>
<p>Acts as a resource dispenser to perform client-side connection pooling.</p>
</li>
</ul>
<a id="NTMTS166" name="NTMTS166"></a><a id="sthref132" name="sthref132"></a>
<p><span class="subhead3">Oracle Net&nbsp;</span>Provides connectivity in distributed, heterogenous computing environments.</p>
<a id="NTMTS167" name="NTMTS167"></a><a id="sthref133" name="sthref133"></a>
<p><span class="subhead3">Oracle MTS Recovery Service&nbsp;</span>Recovers in-doubt Oracle transactions that originated from the host computer and are related to the Microsoft Transaction Server.</p>
<a id="NTMTS168" name="NTMTS168"></a><a id="sthref134" name="sthref134"></a>
<p><span class="subhead3">Database Recovery Job&nbsp;</span>Detects in-doubt DTC transactions. This job extracts the recovery service's endpoint address inthe in-doubt transaction's XID and then requests the outcome of the Microsoft DTC transaction from the recovery service. Ultimately, the job will commit or terminate the in-doubt transaction when it receives the transaction's outcome.</p>
<a id="NTMTS169" name="NTMTS169"></a><a id="sthref135" name="sthref135"></a>
<p><span class="subhead3">Microsoft DTC&nbsp;</span>Microsoft Distributed Transaction Coordinator is part of Microsoft Transaction Server and has two primary responsibilities:</p>
<ul>
<li>
<p>Commits and terminates transactions using the two-phase commit protocol.</p>
</li>
<li>
<p>Monitors transactions that require recovery. Multiple MS DTCs can be involved in a single transaction. When a transactional Microsoft Transaction Server component on computer A invokes another transactional Microsoft Transaction Server component on computer B, a connection is opened between the MS DTC on computer A and the MS DTC on computer B. When the root MS DTC commits or terminates a transaction, it sends the request through all involved MS DTCs. The transaction request is then passed to the OCI connection pooling/Microsoft Transaction Server integration, which sends it to the database.</p>
</li>
</ul>
<a id="NTMTS170" name="NTMTS170"></a><a id="sthref136" name="sthref136"></a>
<p><span class="subhead3">Oracle Database&nbsp;</span>Acts as an RM for Microsoft Transaction Server. This is the database on which the client transaction request is performed.</p>
</div>
<!-- class="sect1" -->
<a id="i1006362" name="i1006362"></a><a id="NTMTS171" name="NTMTS171"></a>
<div class="sect1">
<h2 class="sect1">Microsoft Transaction Server Application Development</h2>
<a id="i1006367" name="i1006367"></a>
<p>OCI connection pooling is used to coordinate a transaction in nearly all application programming interfaces. This sections describes how transactions are registered and how OCI connection pooling coordinates them.</p>
<a id="CEGEGFIJ" name="CEGEGFIJ"></a><a id="NTMTS172" name="NTMTS172"></a>
<div class="sect2">
<h3 class="sect2">Microsoft Transaction Server Component Registration<a id="sthref137" name="sthref137"></a><a id="sthref138" name="sthref138"></a></h3>
<p>Application components that run in the Microsoft Transaction Server environment are created as dynamic link libraries (DLLs). Application components are registered with Microsoft Transaction Server using the Microsoft Transaction Server Explorer graphical user interface (GUI) tool.</p>
<a id="NTMTS173" name="NTMTS173"></a>
<div class="sect3"><!-- infolevel="all" infotype="General" --><a id="sthref139" name="sthref139"></a>
<h4 class="sect3">Types of Registration Components</h4>
<p>When you register the application component, you mark it as one of the following types:</p>
<ul>
<li>
<p><span class="bold">Requires a Transaction</span> The component must run in a transaction. If the transaction does not currently exist, Microsoft Transaction Server automatically creates a new transaction for each method invocation on the component.</p>
</li>
<li>
<p><span class="bold">Supports a Transaction</span> The component can run within the client's transaction. When a new component is created, its context inherits the transaction from the context of the invoking client. If the client does not have a transaction, the new context is also created without one.</p>
</li>
<li>
<p><span class="bold">Requires a New Transaction</span> The component must run within its own transaction. Microsoft Transaction Server automatically creates a new transaction for each method invocation on the component.</p>
</li>
<li>
<p><span class="bold">Does Not Support Transactions</span> The component does not run within a transaction. Each method invocation on the component is performed without a surrounding transaction, regardless of whether the invoking client includes a transaction.</p>
</li>
</ul>
</div>
<!-- class="sect3" -->
<a id="NTMTS174" name="NTMTS174"></a>
<div class="sect3"><!-- infolevel="all" infotype="General" --><a id="sthref140" name="sthref140"></a>
<h4 class="sect3">Registration of Components</h4>
<p>How you register an application component determines if it runs in a Microsoft Transaction Server-coordinated transaction.</p>
<ul>
<li>
<p>If the application component <span class="bold">runs</span> in a Microsoft Transaction Server-coordinated transaction, the OCI connection pooling is always used and Microsoft Transaction Server and its MS DTC component coordinate the creation, startup, management, and commitment phases of the transaction. Microsoft Transaction Server ensures that all changes made by the component are committed if the transaction succeeds, or are terminated if the transaction fails.</p>
</li>
<li>
<p>If the application component <span class="bold">does not run</span> in a Microsoft Transaction Server-coordinated transaction, the component runs in a Microsoft Transaction Server environment, but the databases that it accesses may or may not take part in MS DTC-coordinated transactions. If the transaction is not MS DTC-coordinated, the client application must create, start, manage, and commit the transaction. OCI connection pooling may be used, depending upon the interface accessing the database (such as Oracle Provider for OLE DB, Oracle ODBC Driver, OO4O, or others).</p>
</li>
</ul>
</div>
<!-- class="sect3" --></div>
<!-- class="sect2" -->
<a id="i1006502" name="i1006502"></a><a id="NTMTS175" name="NTMTS175"></a>
<div class="sect2">
<h3 class="sect2">Microsoft Transaction Server-Coordinated Component Transaction<a id="sthref141" name="sthref141"></a><a id="sthref142" name="sthref142"></a></h3>
<p>This section describes how OCI connection pooling, Microsoft Transaction Server, and MS DTC operate with application components in a Microsoft Transaction Server-coordinated transaction environment.</p>
<ol>
<li>
<p>The client API (one of Oracle ODBC Driver, OCI, OO4O, ODP.NET or Oracle Provider for OLE DB) calls OCI function <code>OraMTSSvcGet()</code> to obtain a service context from the OCI connection pooling component.</p>
</li>
<li>
<p>The OCI connection pooling component enlists the transaction that will be coordinated by the MS DTC component of Microsoft Transaction Server.</p>
<p>The OCI service and environment handles are returned to client applications.</p>
</li>
<li>
<p>The client application:</p>
<ul>
<li>
<p>Performs the database operations.</p>
</li>
<li>
<p>Calls OCI function <code>OraMTSSvcRel()</code> to release the OCI pooling connection obtained at the beginning of the transaction.</p>
</li>
<li>
<p>Calls <code>SetComplete</code> (to commit database operations) or <code>SetAbort</code> (to terminate database operations) on the Microsoft Transaction Server context object associated with the component.</p>
</li>
</ul>
</li>
<li>
<p>MS DTC performs the two-phase commit protocol to prepare and commit or to terminate the transaction. This notifies the OCI connection pooling component and ends the transaction.</p>
</li>
<li>
<p>OCI connection pooling is notified and performs the necessary steps to complete phase one, the prepare phase, and phase two, the commit or terminate phase.</p>
</li>
</ol>
</div>
<!-- class="sect2" -->
<a id="i1006530" name="i1006530"></a><a id="NTMTS176" name="NTMTS176"></a>
<div class="sect2">
<h3 class="sect2">Microsoft DTC-Coordinated <a id="sthref143" name="sthref143"></a>Component Transaction<a id="sthref144" name="sthref144"></a><a id="sthref145" name="sthref145"></a></h3>
<p>This section describes how OCI connection pooling, Microsoft Transaction Server, and MS DTC operate with application components <span class="bold">not running</span> in a Microsoft Transaction Server-coordinated transaction, but using MS DTC.</p>
<ol>
<li>
<p>The client application starts an MS DTC transaction and connects to the Oracle Database. The connection protocol follows one of the following scenarios:</p>
<ul>
<li>
<p>Nonpooled OCI connections are obtained through OCI logon calls such as <code>OCIServerAttach()</code> and <code>OCISessionBegin()</code>. For these connections, the application calls <code>OraMTSEnlCtxGet()</code> to associate the OCI service context with a Microsoft Transaction Server enlistment context.</p>
</li>
<li>
<p>A connection pool is obtained by calling <code>OraMTSSvcGet(..,..,ORAMTS_CFLG_NOIMPLICIT)</code>.</p>
</li>
</ul>
</li>
<li>
<p>The client handles the context in one of the following scenarios:</p>
<ul>
<li>
<p>For nonpooled connections, the client application passes in the enlistment context to <code>OraMTSJoinTxn()</code>.</p>
</li>
<li>
<p>For pooled connections, the client application passes the OCI service context into <code>OraMTSSvcEnlist()</code>.</p>
</li>
</ul>
</li>
<li>
<p>The OCI connection pooling component enlists the connection, either pooled or nonpooled, in the transaction coordinated by the MS DTC component of Microsoft Transaction Server.</p>
</li>
<li>
<p>The client application then:</p>
<ul>
<li>
<p>Performs database operations.</p>
</li>
<li>
<p>Calls <code>OraMTSSvcEnlist()</code> with a <code>NULL</code> transaction reference to de-enlist from an MS DTC coordinated transaction.</p>
<p>For nonpooled connections, <code>OraMTSTxnJoin()</code> is invoked with a <code>NULL</code> transaction reference to perform the de-enlistment.</p>
</li>
<li>
<p>Calls <code>OraMTSSvcRel()</code> to release a pooled connection back to the pool.</p>
<p>For nonpooled connections, the client calls <code>OraMTSEnlCtxRel()</code> to release the enlistment context and then logs off the database.</p>
</li>
<li>
<p>Calls the commit or terminate method on the MS DTC transaction object, such as <code>pTransaction-&gt;Commit()</code> or <code>pTransaction-&gt;Abort()</code>.</p>
</li>
</ul>
</li>
<li>
<p>MS DTC performs the two-phase commit protocol to commit the transaction.</p>
</li>
<li>
<p>OCI connection pooling is notified and performs the necessary steps to complete phase one, the prepare phase, and phase two, the commit or terminate phase.</p>
</li>
</ol>
</div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i1006563" name="i1006563"></a><a id="NTMTS177" name="NTMTS177"></a>
<div class="sect1">
<h2 class="sect1">OCI<a id="sthref146" name="sthref146"></a><a id="sthref147" name="sthref147"></a><a id="sthref148" name="sthref148"></a> Integration with Microsoft Transaction Server</h2>
<p><a href="#BEJGDDFA">Example 4-1</a> illustrates how you can integrate the MTS sever with OCI. The only change in code you must make involves obtaining and releasing the OCI service context handle. Both OCI service context handle and environment handle are acquired when you obtain a pooled OCI connection to the database by calling <code>OraMTSSvcGet()</code>. Include the <code>oramts.h</code> header and link with the <code>oramts.lib</code> library. When you are finished, call OCI function <a id="sthref149" name="sthref149"></a><a id="sthref150" name="sthref150"></a><code>OraMTSSvcRel()</code> to release the service context handle and environment handle. Using <code>OraMTSSvcGet()</code> enables you to receive connection pooling and implicit transaction support if you registered the application component to run in a Microsoft Transaction Server transaction.</p>
<p><a id="sthref151" name="sthref151"></a><a id="sthref152" name="sthref152"></a>Ensure that for each process, you call <code>OCIInitialize</code> at least once before executing any other OCI calls. This initializes the OCI process environment. In addition, you must pass it the <code>OCI_THREADED</code> flag. If you are using Microsoft Internet Information Server (IIS) and the components are being called as in-process libraries, then <code>OCIInitialize</code> is already called for you. The registry key <code>ORAMTS_OCI_OBJ_MODE</code> has been added. Set the value to 1 to initialize OCI in Object mode; otherwise OCI will initialize in the threaded mode.</p>
<div class="example"><a id="BEJGDDFA" name="BEJGDDFA"></a><a id="NTMTS178" name="NTMTS178"></a>
<p class="titleinexample">Example 4-1 Integration of MTS and OCI</p>
<pre xml:space="preserve" class="oac_no_warn">#include &lt;oci.h&gt; 
#include  &lt;oramts.h&gt; 
#include  &lt;xolehlp.h&gt; 
// other MTS relevant includes ... 
 
// prototype for the error handler. 
BOOL Chekerr(sword swOCIStat, OCIError *OCIErrh); 
 
// MTS component method 
HRESULT OCITestMethod() 
{ 
 IObjectContext *pObjectContext = NULL; 
 OCIEnv    *myenvh = NULL; 
 OCISvcCtx *mysvch = NULL; 
 OCIError  *myerrh = NULL; 
 OCIStnt   *mystmh = NULL; 
 DWORD      dwStat; 
 HRESULT    hRes = S_OK; 
 sword      swOCIStat; 
 BOOL       bCommit = FALSE; 
 char      *lpzStmt = "UPDATE EMP SET SAL = SAL + 1000"; 
 
 // Initialize the OCI environment first -- request OCI_THREADED 
 OCIInitialize(OCI_THREADED, (dvoid*)NULL,NULL,NULL,NULL);  
 // attempt to get a connection to the database through the resource dispenser 
 OraMTSSvcGet( 
"hr","<span class="italic">hr_password</span>","finprod_db",&amp;mysvch, &amp;myenvh, ORAMTS_CFLG_ALLDEFAULT);  
 // validate return status 
 if(dwStat != ORAMTS_ERR_NOERROR) 
 { 
   printf("error: failed to obtain a connection to the database - %ld", 
dwStat); 
   goto cleanup; 
 } 
 // successful logon and enlistment in the MTS transaction. allocate statement 
 // handles and other handles using the OCI environment handle myenvh .... 
 swOCIStat = OCIHandleAlloc(myenvh, (void *)&amp;myerrh,OCI_HTYPE_ERROR, 0 , NULL); 
 if (Checkerr(swOCIStat, myerrh)) goto cleanup; 
 swOCIStat = OCIHandleAlloc(myenvh, (dvoid *)&amp;mystmh,OCI_HTYPE_STMT, 0,NULL); 
 if (Checkerr(swOCIStat, myerrh)) goto cleanup;
 // prepare a DML statement 
 OCIStmtPrepare(mystmh, myerrh, lpzStmt, lstrlen(lpzStmt), OCI_NTV_SYNTAX, 
OCI_DEFAULT) 
 Checkerr(swOCIStat, myerrh);  
 // execute the statement -- ensure that AUTOCOMMIT is not requested. 
 OCIStmtExecute(mysvch, mystmh, myerrh, 1, 0, NULL, NULL, OCI_DEFAULT); 
 if (Checkerr(swOCIStat, myerrh)) goto cleanup;  
 // all's well so far choose to go for a commit 
 bCommit = TRUE;  
cleanup: 
 if (mystmh) OCIHandleFree((void*)mystmh, OCI_HTYPE_STMT); 
 if (myerrh  OCIHandleFree((void*)myerrh, OCI_HTYPE_ERROR); 
 if (mysvch) OraMTSSvcRel(mysvch);  
 if (bCommit)  
     pObjectContext-&gt;SetComplete();  
 else 
     pObjectContext-&gt;Abort();   
 return(bCommit ? S_OK : E_FAIL); 
}
</pre></div>
<!-- class="example" -->
<a id="NTMTS179" name="NTMTS179"></a>
<div class="sect2"><!-- infolevel="all" infotype="General" --><a id="sthref153" name="sthref153"></a>
<h3 class="sect2">Integrating COM Components</h3>
<p>There are several scenarios for integrating COM components. COM applications that are not hosted by the Microsoft Transaction Server environment, also known as standalone applications, cannot use declarative transactions through the Microsoft Transaction Server Explorer Microsoft Management Console, but they can use the last three of the scenario described.</p>
<a id="NTMTS180" name="NTMTS180"></a>
<div class="sect3"><!-- infolevel="all" infotype="General" --><a id="sthref154" name="sthref154"></a>
<h4 class="sect3">COM Components Running in an MTS-Coordinated Transaction</h4>
<p>COM components that are running in an MTS-coordinated transactions use OCI connection pooling to implicitly enlist the database in a transaction. The following pseudo-code listing illustrates the use of OCI functions:</p>
<pre xml:space="preserve" class="oac_no_warn">OCIInitialize(OCI_THREADED, ...)
OraMTSSvcGet(..., &amp;OCISvc, ..., ORAMTS_CFLAG_ALLDEFAULT)
...
OraMTSSvcRel(OCISvc)
</pre></div>
<!-- class="sect3" -->
<a id="NTMTS181" name="NTMTS181"></a>
<div class="sect3"><!-- infolevel="all" infotype="General" --><a id="sthref155" name="sthref155"></a>
<h4 class="sect3">Non-Transactional COM Components Running with OCI Connection Pooling</h4>
<p>COM components that are marked as non-transactional and running in an MTS-coordinated transaction use OCI connection pooling <span class="bold">do not enlist</span> the database in a transaction. The following pseudo-code listing illustrates the use of OCI functions:</p>
<pre xml:space="preserve" class="oac_no_warn">OCIInitialize(OCI_THREADED, ...)
OraMTSSvcGet(..., &amp;OCISvc, ..., ORAMTS_CFLAG_NOIMPLICIT)
...
OraMTSSvcRel(OCISvc)
</pre></div>
<!-- class="sect3" -->
<a id="NTMTS182" name="NTMTS182"></a>
<div class="sect3"><!-- infolevel="all" infotype="General" --><a id="sthref156" name="sthref156"></a>
<h4 class="sect3">COM Components Using MS DTC and OCI Connection Pooling</h4>
<p>COM components that are not running in an MTS-coordinated transaction use MS DTC with OCI connection pooling to explicitly enlist the database in a transaction. The following pseudo-code listing illustrates the use of OCI functions:</p>
<pre xml:space="preserve" class="oac_no_warn">OCIInitialize(OCI_THREADED, ...)
DTCGetTransactionManager(...)
BeginTransaction(..., &amp;transaction)
OraMTSSvcGet(..., &amp;OCISvc, ..., ORAMTS_CFLAG_NOIMPLICIT)
OraMTSSvcEnlist(OCISvc, ..., transaction, ...)
...
OraMTSvcEnlist(OCISvc, ..., NULL, ...)
OraMTSSvcRel(OCISvc)
</pre></div>
<!-- class="sect3" -->
<a id="NTMTS183" name="NTMTS183"></a>
<div class="sect3"><!-- infolevel="all" infotype="General" --><a id="sthref157" name="sthref157"></a>
<h4 class="sect3">COM Components Using MS DTC and Nonpooling OCI Connection</h4>
<p>COM components that are not running in an MTS-coordinated transaction use MS DTC with a non-pooling OCI connection to explicitly enlist the database in a transaction. The following pseudo-code listing illustrates the use of OCI functions:</p>
<pre xml:space="preserve" class="oac_no_warn">OCIInitialize(OCI_THREADED, ...)
OCI to get connected
OraMTSEnlCtxGET
DTCGetTransactionManager(...)
BeginTransaction(..., &amp;transaction)
OraMTSJoinTxn (OCISvc, ..., transaction, ...)
...
OraMTSJoinTxn
...
OraMTSEnlCtxRel()
OCI to logoff
</pre></div>
<!-- class="sect3" --></div>
<!-- class="sect2" -->
<a id="i1006616" name="i1006616"></a><a id="NTMTS184" name="NTMTS184"></a>
<div class="sect2">
<h3 class="sect2">Using OCI Functions</h3>
<p>This section details the OCI functions discussed earlier in this section. <a href="#BEJGEJFD">Table 4-1</a> summarizes these functions.</p>
<div class="tblformal"><a id="NTMTS185" name="NTMTS185"></a><a id="sthref158" name="sthref158"></a><a id="BEJGEJFD" name="BEJGEJFD"></a>
<p class="titleintable">Table 4-1 Summary of OCI Functions for Integrating MTS and Oracle Database</p>
<table class="Formal" title="Summary of OCI Functions for Integrating MTS and Oracle Database" summary="This table lists OCI function in the first column, and provides a brief description of the function in the second column." dir="ltr" border="1" width="100%" frame="hsides" rules="groups" cellpadding="3" cellspacing="0">
<col width="24%" />
<col width="*" />
<thead>
<tr align="left" valign="top">
<th align="left" valign="bottom" id="r1c1-t3">OCI Function</th>
<th align="left" valign="bottom" id="r1c2-t3">Summary</th>
</tr>
</thead>
<tbody>
<tr align="left" valign="top">
<td align="left" id="r2c1-t3" headers="r1c1-t3">
<p><a href="#i1006742">OraMTSSvcGet()</a></p>
</td>
<td align="left" headers="r2c1-t3 r1c2-t3">
<p>Obtains a pooled connection from the OCI connection pool.</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r3c1-t3" headers="r1c1-t3">
<p><a href="#i1006918">OraMTSSvcRel()</a></p>
</td>
<td align="left" headers="r3c1-t3 r1c2-t3">
<p>Releases a pooled OCI connection, OCI service context, back to the connection pool.</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r4c1-t3" headers="r1c1-t3">
<p><a href="#i1006965">OraMTSSvcEnlist()</a></p>
</td>
<td align="left" headers="r4c1-t3 r1c2-t3">
<p>Enlists or de-enlists an OCI connection in a transaction coordinated by MS DTC.</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r5c1-t3" headers="r1c1-t3">
<p><a href="#i1007043">OraMTSSvcEnlistEx()</a></p>
</td>
<td align="left" headers="r5c1-t3 r1c2-t3">
<p>Enlists an OCI connection or service context in an MS DTC transaction.</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r6c1-t3" headers="r1c1-t3">
<p><a href="#i1007117">OraMTSEnlCtxGet()</a></p>
</td>
<td align="left" headers="r6c1-t3 r1c2-t3">
<p>Creates an enlistment context for a nonpooled OCI connection.</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r7c1-t3" headers="r1c1-t3">
<p><a href="#i1007218">OraMTSEnlCtxRel()</a></p>
</td>
<td align="left" headers="r7c1-t3 r1c2-t3">
<p>Eliminates a previously set up enlistment context for a nonpooled OCI connection.</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r8c1-t3" headers="r1c1-t3">
<p><a href="#i1007259">OraMTSJoinTxn()</a></p>
</td>
<td align="left" headers="r8c1-t3 r1c2-t3">
<p>Enlists a nonpooled OCI connection in an MS DTC transaction.</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r9c1-t3" headers="r1c1-t3">
<p><a href="#i1007305">OraMTSTransTest()</a></p>
</td>
<td align="left" headers="r9c1-t3 r1c2-t3">
<p>Tests if you are running inside a Microsoft Transaction Server-started transaction.</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r10c1-t3" headers="r1c1-t3">
<p><a href="#i1007335">OraMTSOCIErrGet()</a></p>
</td>
<td align="left" headers="r10c1-t3 r1c2-t3">
<p>Retrieves the OCI error code and message text.</p>
</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="tblformal" --></div>
<!-- class="sect2" -->
<a id="i1006742" name="i1006742"></a><a id="NTMTS186" name="NTMTS186"></a>
<div class="sect2">
<h3 class="sect2">OraMTSSvcGet() <a id="sthref159" name="sthref159"></a><a id="sthref160" name="sthref160"></a><a id="sthref161" name="sthref161"></a><a id="sthref162" name="sthref162"></a><a id="sthref163" name="sthref163"></a><a id="sthref164" name="sthref164"></a></h3>
<p>Obtains a pooled connection, also known as an OCI service context, from the OCI connection pool. The pooled connection includes an OCI service context handle and an OCI environment handle.</p>
<a id="NTMTS187" name="NTMTS187"></a>
<p class="subhead2">Syntax<a id="sthref165" name="sthref165"></a></p>
<pre xml:space="preserve" class="oac_no_warn">DWORD  OraMTSSvcGet( 
</pre>
<pre xml:space="preserve" class="oac_no_warn">text*       lpUname,
                 text*       lpPsswd,
                 text*       lpDbnam,
                 OCISvcCtx** pOCISvc,
                 OCIEnv**    pOCIEnv,
                 ub4         dwConFlgs);
</pre>
<a id="NTMTS188" name="NTMTS188"></a>
<p class="subhead2">Parameters<a id="sthref166" name="sthref166"></a><a id="sthref167" name="sthref167"></a></p>
<div class="tblformal"><a id="NTMTS189" name="NTMTS189"></a><a id="sthref168" name="sthref168"></a><a id="g1018785" name="g1018785"></a>
<p class="titleintable">Table 4-2 OraMTSSvcGet() Parameters</p>
<table class="Formal" title=" OraMTSSvcGet() Parameters" summary="OraMTSSvcGet() parameters. Column 1 lists the parameter, column 2 indicates if the parameter has an IN or OUT binding, and column 3 contains a description of the parameter." dir="ltr" border="1" width="100%" frame="hsides" rules="groups" cellpadding="3" cellspacing="0">
<col width="16%" />
<col width="10%" />
<col width="*" />
<thead>
<tr align="left" valign="top">
<th align="left" valign="bottom" id="r1c1-t4">Parameter</th>
<th align="left" valign="bottom" id="r1c2-t4">IN/OUT</th>
<th align="left" valign="bottom" id="r1c3-t4">Description</th>
</tr>
</thead>
<tbody>
<tr align="left" valign="top">
<td align="left" id="r2c1-t4" headers="r1c1-t4">
<p><code>lpUname</code></p>
</td>
<td align="left" headers="r2c1-t4 r1c2-t4">
<pre xml:space="preserve" class="oac_no_warn">IN
</pre></td>
<td align="left" headers="r2c1-t4 r1c3-t4">
<p>Username for connecting to the Oracle Database</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r3c1-t4" headers="r1c1-t4">
<p><code>lpPsswd</code></p>
</td>
<td align="left" headers="r3c1-t4 r1c2-t4">
<pre xml:space="preserve" class="oac_no_warn">IN
</pre></td>
<td align="left" headers="r3c1-t4 r1c3-t4">
<p>Password for the username</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r4c1-t4" headers="r1c1-t4">
<p><code>lpDbnam</code></p>
</td>
<td align="left" headers="r4c1-t4 r1c2-t4">
<pre xml:space="preserve" class="oac_no_warn">IN
</pre></td>
<td align="left" headers="r4c1-t4 r1c3-t4">
<p>The <a href="glossary.htm#BGBDDJAE"><span class="xrefglossterm">net service name</span></a> for connecting to the database (created with Oracle Net Manager or Oracle Net Configuration Assistant)</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r5c1-t4" headers="r1c1-t4">
<p><code>pOCISvc</code></p>
</td>
<td align="left" headers="r5c1-t4 r1c2-t4">
<pre xml:space="preserve" class="oac_no_warn">OUT
</pre></td>
<td align="left" headers="r5c1-t4 r1c3-t4">
<p>Pointer to the OCI service context handle</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r6c1-t4" headers="r1c1-t4">
<p><code>pOCIEnv</code></p>
</td>
<td align="left" headers="r6c1-t4 r1c2-t4">
<pre xml:space="preserve" class="oac_no_warn">OUT
</pre></td>
<td align="left" headers="r6c1-t4 r1c3-t4">
<p>Pointer to the OCI environment handle</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r7c1-t4" headers="r1c1-t4">
<p><code>dwConFlgs</code></p>
</td>
<td align="left" headers="r7c1-t4 r1c2-t4">
<pre xml:space="preserve" class="oac_no_warn">IN
</pre></td>
<td align="left" headers="r7c1-t4 r1c3-t4">
<p>Connection flags. Possible values are:</p>
<ul>
<li>
<p><code><a id="sthref169" name="sthref169"></a><a id="sthref170" name="sthref170"></a>ORAMTS_CFLG_ALLDEFAULT</code></p>
<p>Obtains a pooled connection and enlists the connection in any Microsoft Transaction Server transaction, if one exists. If the component is nontransactional, no enlistment request is dispensed.</p>
</li>
<li>
<p><code>ORAMTS_CFLG_NOIMPLICIT</code></p>
<p>Obtains a pooled connection, but does not enlist the resource in any Microsoft Transaction Server transaction even if the component is transactional. Use this flag if the component enlists the connection resource later using <code>OraMTSSvcEnlist()</code>. Prior to releasing a connection obtained in this fashion, the client must de-enlist the resource if enlisted.</p>
</li>
<li>
<p>ORAMTS_CFLG_UNIQUESRVR</p>
<p>Requests a single OCI session for each OCI Server. In this release, multiplexing is not supported. Therefore, this option is always used.</p>
</li>
<li>
<p><code>ORAMTS_CFLG_SYSDBALOGN<a id="sthref171" name="sthref171"></a><a id="sthref172" name="sthref172"></a></code></p>
<p>Use this flag if connecting as <code>SYSDBA</code>.</p>
</li>
<li>
<p><code>ORAMTS_CFLG_SYSOPRLOGN<a id="sthref173" name="sthref173"></a><a id="sthref174" name="sthref174"></a></code></p>
<p>Use this flag if connecting as <code>SYSOPER</code>.</p>
</li>
<li>
<p><code>ORAMTS_CFLG_PRELIMAUTH</code></p>
<p>Use this flag if connecting as the user <code>INTERNAL</code> to pre-Oracle9<span class="italic">i</span> databases. The <code>INTERNAL</code> account is no longer valid as of Oracle9<span class="italic">i</span>. Instead, log on with a <code>SYSDBA</code> or <code>SYSOPER</code> account using the <code>ORAMTS_CFLG_SYSOPRLOGN</code> or <code>ORAMTS_CFLG_SYSDBALOGN</code> flag.</p>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="tblformal" -->
<a id="NTMTS190" name="NTMTS190"></a>
<p class="subhead2">Returns<a id="sthref175" name="sthref175"></a><a id="sthref176" name="sthref176"></a></p>
<p>Returns <code>ORAMTSERR_NOERROR</code> upon successful acquisition of an OCI pooling connection (OCI service context).</p>
<a id="NTMTS191" name="NTMTS191"></a>
<p class="subhead2">Usage Notes</p>
<ul>
<li>
<p><a id="sthref177" name="sthref177"></a><a id="sthref178" name="sthref178"></a><code>OraMTSSvcGet()</code> returns a pooled OCI connection to the caller, enabling a database transaction using OCI to begin. Use <code>OraMTSSvcGet()</code> to implicitly enlist the OCI connection in a transaction coordinated by Microsoft Transaction Server. In this type of transaction, Microsoft Transaction Server controls the creation, startup, management, and commitment phases of the transaction through its MS DTC component.</p>
</li>
<li>
<p><code>OraMTSSvcGet()</code> also provides connection pooling without enlisting the Oracle Database in a Microsoft Transaction Server transaction. This is done by setting <code>OraMTSSvcGet()</code> as follows:</p>
<pre xml:space="preserve" class="oac_no_warn">OraMTSSvcGet(...,ORAMTS_CFLG_NOIMPLICIT)
</pre></li>
<li>
<p>In all cases where <code>OraMTSSvcGet</code><code>()</code> is used, you must always use <code>OraMTSSvcRel</code><code>()</code> to release the connection when finished.</p>
</li>
<li>
<p>Use the flags <a id="sthref179" name="sthref179"></a><a id="sthref180" name="sthref180"></a><code>ORAMTS_CFLG_SYSDBALOGN</code> and <code>ORAMTS_CFLG_SYSOPRLOGN</code> when connecting as <code>SYSDBA</code> and <code>SYSOPER</code>, respectively.</p>
</li>
<li>
<p>To obtain a nonenlisted connection using the <code>hr</code>/<code><span class="codeinlineitalic">hr_password</span></code> account, call <code>OraMTSSvcGet()</code> as follows:</p>
<pre xml:space="preserve" class="oac_no_warn">OraMTSSvcGet("hr", "<span class="italic">hr_password</span>", "oracle", &amp;OCISvc, &amp;OCIEnv, ORAMTS_CFLG_ALLDEFAULT | ORAMTS_CFLG_NOIMPLICIT);
</pre></li>
<li>
<p><code>OraMTSSvcGet()</code> does not support placing the username (<code>lpUname</code>), password (<code>lpPsswd</code>), and net service name syntax (<code>lpDbname</code>) together in the username argument (for example, <code>hr/</code><code><span class="codeinlineitalic">hr_password</span></code><code>@prod_fin</code>). Instead, the caller must fill in <code>lpUname</code>, <code>lpPsswd</code>, and <code>lpDbname</code> separately (as shown in the previous syntax example). Calling <code>OraMTSSvcGet()</code> with the username and password as <code>NULL</code> strings uses external authentication (operating system authentication) for the connection.</p>
</li>
</ul>
</div>
<!-- class="sect2" -->
<a id="i1006918" name="i1006918"></a><a id="NTMTS192" name="NTMTS192"></a>
<div class="sect2">
<h3 class="sect2">OraMTSSvcRel()<a id="sthref181" name="sthref181"></a><a id="sthref182" name="sthref182"></a><a id="sthref183" name="sthref183"></a></h3>
<p>Releases a pooled OCI connection, OCI service context, back to the connection pool. Use this function to release connections that were acquired with <code>OraMTSSvcGet()</code>.</p>
<a id="NTMTS193" name="NTMTS193"></a>
<p class="subhead2">Syntax<a id="sthref184" name="sthref184"></a></p>
<pre xml:space="preserve" class="oac_no_warn">DWORD OraMTSSvcRel(OCISvcCtx* OCISvc);
</pre>
<a id="NTMTS194" name="NTMTS194"></a>
<p class="subhead2">Parameters</p>
<div class="tblformal"><a id="NTMTS195" name="NTMTS195"></a><a id="sthref185" name="sthref185"></a><a id="g1019881" name="g1019881"></a>
<p class="titleintable">Table 4-3 OraMTSSvcRel() Parameters</p>
<table class="Formal" title="OraMTSSvcRel() Parameters" summary="OraMTSSvcRel() parameters. Column 1 lists the parameter, column 2 indicates if the parameter has an IN or OUT binding, and column 3 contains a description of the parameter." dir="ltr" border="1" width="100%" frame="hsides" rules="groups" cellpadding="3" cellspacing="0">
<col width="14%" />
<col width="10%" />
<col width="*" />
<thead>
<tr align="left" valign="top">
<th align="left" valign="bottom" id="r1c1-t5">Parameter</th>
<th align="left" valign="bottom" id="r1c2-t5">IN/OUT</th>
<th align="left" valign="bottom" id="r1c3-t5">Description</th>
</tr>
</thead>
<tbody>
<tr align="left" valign="top">
<td align="left" id="r2c1-t5" headers="r1c1-t5">
<p><code>OCISvc</code></p>
</td>
<td align="left" headers="r2c1-t5 r1c2-t5">
<pre xml:space="preserve" class="oac_no_warn">IN
</pre></td>
<td align="left" headers="r2c1-t5 r1c3-t5">
<p>OCI service context for a pooled connection</p>
</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="tblformal" -->
<a id="NTMTS196" name="NTMTS196"></a>
<p class="subhead2">Returns<a id="sthref186" name="sthref186"></a><a id="sthref187" name="sthref187"></a></p>
<p>Returns <code>ORAMTSERR_NOERROR</code> upon successful release of a pooled OCI connection.</p>
<a id="NTMTS197" name="NTMTS197"></a>
<p class="subhead2">Usage Notes</p>
<ul>
<li><a id="i1006959" name="i1006959"></a>
<p><a id="sthref188" name="sthref188"></a><a id="sthref189" name="sthref189"></a><a id="sthref190" name="sthref190"></a>An OCI pooled connection obtained through a previous call to <code>OraMTSSvcGet()</code> is released back to the connection pool. Once released back to the connection pool, the OCI service context, its environment handle, and all child handles are invalid.</p>
</li>
<li>
<p>A nontransactional client component must explicitly call <code>OCITransCommit()</code> or <code>OCITransAbort()</code> prior to releasing a connection obtained through <code>OraMTSSvcGet(..., ...,ORAMTS_CFLG_ALLDEFAULT)</code> back to the pool. Otherwise, all changes made in that session are rolled back. A transaction component uses the <code>SetComplete</code> or <code>SetAbort</code> methods on its Microsoft Transaction Server object context.</p>
</li>
<li>
<p>Components that have called <code>OraMTSSvcGet(..., ...,ORAMTS_CFLG_NOIMPLICIT)</code> to obtain a connection resource must first de-enlist the resource if enlisted. If the connection was enlisted explicitly, <code>pTransaction-&gt;Commit()</code> or <code>pTransaction-&gt;Abort()</code> must be called. Otherwise, <code>OCITransCommit()</code> or <code>OCITransAbort()</code> must be called before releasing the connection back to the pool.</p>
</li>
</ul>
</div>
<!-- class="sect2" -->
<a id="i1006965" name="i1006965"></a><a id="NTMTS198" name="NTMTS198"></a>
<div class="sect2">
<h3 class="sect2">OraMTSSvcEnlist() <a id="sthref191" name="sthref191"></a><a id="sthref192" name="sthref192"></a><a id="sthref193" name="sthref193"></a><a id="sthref194" name="sthref194"></a></h3>
<p>Enlists or de-enlists an OCI connection in a transaction coordinated by MS DTC. Use this call to explicitly enlist pooled connections. Nonpooled connections must enlist with <code>OraMTSJoinTxn()</code>.</p>
<a id="NTMTS199" name="NTMTS199"></a>
<p class="subhead2">Syntax<a id="sthref195" name="sthref195"></a></p>
<pre xml:space="preserve" class="oac_no_warn">DWORD OraMTSSvcEnlist(
</pre>
<pre xml:space="preserve" class="oac_no_warn">OCISvcCtx*  OCISvc, 
                   OCIError*   OCIErr, 
                   void*       lpTrans, 
                   unsigned    dwFlags);
</pre>
<a id="NTMTS200" name="NTMTS200"></a>
<p class="subhead2">Parameters<a id="sthref196" name="sthref196"></a><a id="sthref197" name="sthref197"></a></p>
<div class="tblformal"><a id="NTMTS201" name="NTMTS201"></a><a id="sthref198" name="sthref198"></a><a id="g1020053" name="g1020053"></a>
<p class="titleintable">Table 4-4 OraMTSSvcEnlist() Parameters</p>
<table class="Formal" title="OraMTSSvcEnlist() Parameters" summary="OraMTSSvcEnlist() parameters. Column 1 lists the parameter, column 2 indicates if the parameter has an IN or OUT binding, and column 3 contains a description of the parameter." dir="ltr" border="1" width="100%" frame="hsides" rules="groups" cellpadding="3" cellspacing="0">
<col width="15%" />
<col width="12%" />
<col width="*" />
<thead>
<tr align="left" valign="top">
<th align="left" valign="bottom" id="r1c1-t6">Parameter</th>
<th align="left" valign="bottom" id="r1c2-t6">IN/OUT</th>
<th align="left" valign="bottom" id="r1c3-t6">Description</th>
</tr>
</thead>
<tbody>
<tr align="left" valign="top">
<td align="left" id="r2c1-t6" headers="r1c1-t6">
<p><code>OCISvc</code></p>
</td>
<td align="left" headers="r2c1-t6 r1c2-t6">
<p><code>IN</code></p>
</td>
<td align="left" headers="r2c1-t6 r1c3-t6">
<p>OCI service context for pooled connections obtained by calling <code>OraMTSSvcGet()</code></p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r3c1-t6" headers="r1c1-t6">
<p><code>OCIErr</code></p>
</td>
<td align="left" headers="r3c1-t6 r1c2-t6">
<p><code>IN/OUT</code></p>
</td>
<td align="left" headers="r3c1-t6 r1c3-t6">
<p>OCI error handle (ignored)</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r4c1-t6" headers="r1c1-t6">
<p><code>lpTrans</code></p>
</td>
<td align="left" headers="r4c1-t6 r1c2-t6">
<p><code>IN</code></p>
</td>
<td align="left" headers="r4c1-t6 r1c3-t6">
<p>Pointer to the MS DTC-controlled transaction in which to enlist. If <code>NULL</code>, the OCI connection is de-enlisted from the MS DTC-controlled transaction.</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r5c1-t6" headers="r1c1-t6">
<p><code>dwFlags</code></p>
</td>
<td align="left" headers="r5c1-t6 r1c2-t6">
<p><code>IN</code></p>
</td>
<td align="left" headers="r5c1-t6 r1c3-t6">
<p>Flag used for enlisting in a transaction. Use the <code>ORAMTS_ENFLG_DEFAULT<a id="sthref199" name="sthref199"></a><a id="sthref200" name="sthref200"></a></code> value. If enlisting, then start a new Oracle global transaction. If de-enlisting, then detach from any global Oracle transaction and delete the context object if the OCI service context represents a nonpooled connection.</p>
</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="tblformal" -->
<a id="NTMTS202" name="NTMTS202"></a>
<p class="subhead2">Returns<a id="sthref201" name="sthref201"></a><a id="sthref202" name="sthref202"></a></p>
<p>Returns <code>ORAMTSERR_NOERROR</code> on success.</p>
<a id="NTMTS203" name="NTMTS203"></a>
<p class="subhead2">Usage Notes<a id="sthref203" name="sthref203"></a><a id="sthref204" name="sthref204"></a></p>
<ul>
<li>
<p>Use this call to explicitly enlist or de-enlist a pooled connection. For enlisting and de-enlisting nonpooled connections, use <code>OraMTSSvcRel()</code>.</p>
</li>
<li>
<p><code>OraMTSSvcEnlist()</code> enlists (or de-enlists) pooled OCI connections obtained previously through <code>OraMTSSvcGet()</code> with the <code>ORAMTS_CFLG_NOIMPLICIT</code> flag and not yet released with <code>OraMTSSvcRel()</code>. The pooled OCI connections must be explicitly enlistable. When the transaction is complete, you must de-enlist <code>OraMTSSvcEnlist()</code>, passing <code>NULL</code> as the transaction pointer as follows:</p>
<pre xml:space="preserve" class="oac_no_warn">OraMTSSvcEnlist (OCISvc, OCIErr, NULL, ORAMTS_ENFLG_DEFAULT)
</pre>
<p>You must use <code>OraMTSSvcRel()</code> to release the connection when done.</p>
</li>
<li>
<p>Callers must allocate a connection, enlist the connection, perform work, de-enlist the connection, release the connection, and then attempt to commit or terminate.</p>
</li>
</ul>
</div>
<!-- class="sect2" -->
<a id="i1007043" name="i1007043"></a><a id="NTMTS204" name="NTMTS204"></a>
<div class="sect2">
<h3 class="sect2">OraMTSSvcEnlistEx()<a id="sthref205" name="sthref205"></a></h3>
<p>Enlists an OCI connection or service context in an MS DTC transaction. Use this call only to explicitly enlist pooled connections. Nonpooled connections must enlist with <code>OraMTSJoinTxn()</code>.</p>
<a id="NTMTS205" name="NTMTS205"></a>
<p class="subhead2">Syntax<a id="sthref206" name="sthref206"></a></p>
<pre xml:space="preserve" class="oac_no_warn">DWORD OraMTSSvcEnlistEx(
                     OCISvcCtx* OCISvc, 
</pre>
<pre xml:space="preserve" class="oac_no_warn">OCIError*  OCIErr, 
                     void*      lpTrans, 
                     unsigned   dwFlags,
                     char*      lpDBName);
</pre>
<a id="NTMTS206" name="NTMTS206"></a>
<p class="subhead2">Parameters</p>
<div class="tblformal"><a id="NTMTS207" name="NTMTS207"></a><a id="sthref207" name="sthref207"></a><a id="g1020452" name="g1020452"></a>
<p class="titleintable">Table 4-5 OraMTSSvcEnlistEx() Parameters</p>
<table class="Formal" title=" OraMTSSvcEnlistEx() Parameters" summary="OraMTSSvcEnlistEx() parameters. Column 1 lists the parameter, column 2 indicates if the parameter has an IN or OUT binding, and column 3 contains a description of the parameter." dir="ltr" border="1" width="100%" frame="hsides" rules="groups" cellpadding="3" cellspacing="0">
<col width="14%" />
<col width="10%" />
<col width="*" />
<thead>
<tr align="left" valign="top">
<th align="left" valign="bottom" id="r1c1-t7">Parameter</th>
<th align="left" valign="bottom" id="r1c2-t7">IN/OUT</th>
<th align="left" valign="bottom" id="r1c3-t7">Description</th>
</tr>
</thead>
<tbody>
<tr align="left" valign="top">
<td align="left" id="r2c1-t7" headers="r1c1-t7">
<p><code>OCISvc</code></p>
</td>
<td align="left" headers="r2c1-t7 r1c2-t7">
<p><code>IN</code></p>
</td>
<td align="left" headers="r2c1-t7 r1c3-t7">
<p>OCI service context for pooled connections obtained by calling <code>OraMTSSvcGet()</code></p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r3c1-t7" headers="r1c1-t7">
<p><code>OCIErr</code></p>
</td>
<td align="left" headers="r3c1-t7 r1c2-t7">
<p><code>IN/OUT</code></p>
</td>
<td align="left" headers="r3c1-t7 r1c3-t7">
<p>OCI error handle (ignored)</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r4c1-t7" headers="r1c1-t7">
<p><code>lpTrans</code></p>
</td>
<td align="left" headers="r4c1-t7 r1c2-t7">
<p><code>IN</code></p>
</td>
<td align="left" headers="r4c1-t7 r1c3-t7">
<p>Pointer to the MS DTC-controlled transaction in which to enlist. If <code>NULL</code>, the OCI connection is de-enlisted from the MS DTC-controlled transaction.</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r5c1-t7" headers="r1c1-t7">
<p><code>dwFlags</code></p>
</td>
<td align="left" headers="r5c1-t7 r1c2-t7">
<p><code>IN</code></p>
</td>
<td align="left" headers="r5c1-t7 r1c3-t7">
<p>Flag used for enlisting in a transaction. Use the <code>ORAMTS_ENFLG_DEFAULT<a id="sthref208" name="sthref208"></a><a id="sthref209" name="sthref209"></a></code> value. If enlisting, then start a new Oracle global transaction. If de-enlisting, then detach from any global Oracle transaction and delete the context object if the OCI service context represents a nonpooled connection.</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r6c1-t7" headers="r1c1-t7">
<p><code>lpDBName</code></p>
</td>
<td align="left" headers="r6c1-t7 r1c2-t7">
<p><code>-</code></p>
</td>
<td align="left" headers="r6c1-t7 r1c3-t7">
<p>Net service name for connecting to the database (created with Oracle Net Manager or Oracle Net Configuration Assistant)</p>
</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="tblformal" -->
<a id="NTMTS208" name="NTMTS208"></a>
<p class="subhead2">Returns<a id="sthref210" name="sthref210"></a><a id="sthref211" name="sthref211"></a></p>
<p>Returns <code><a id="sthref212" name="sthref212"></a>ORAMTSERR_ILLEGAL_OPER</code>.</p>
<a id="NTMTS209" name="NTMTS209"></a>
<p class="subhead2">Usage Notes<a id="sthref213" name="sthref213"></a></p>
<p>Use <code>OraMTSSvcEnlistEx()</code> for pooled connections or <code>OraMTSJoinTxn()</code> for nonpooled connections.</p>
</div>
<!-- class="sect2" -->
<a id="i1007117" name="i1007117"></a><a id="NTMTS210" name="NTMTS210"></a>
<div class="sect2">
<h3 class="sect2">OraMTSEnlCtxGet() <a id="sthref214" name="sthref214"></a><a id="sthref215" name="sthref215"></a></h3>
<p>Creates an enlistment context for a nonpooled OCI connection.</p>
<a id="NTMTS211" name="NTMTS211"></a>
<p class="subhead2">Syntax</p>
<pre xml:space="preserve" class="oac_no_warn">DWORD OraMTSEnlCtxGet(
</pre>
<pre xml:space="preserve" class="oac_no_warn">text*       lpUname,
                     text*       lpPsswd,
                     text*       lpDbnam,              
                     OCISvcCtx*  pOCISvc,
                     OCIError*   pOCIErr,
                     ub4         dwFlags,
                     void**      pCtxt);
</pre>
<a id="NTMTS212" name="NTMTS212"></a>
<p class="subhead2">Parameters<a id="sthref216" name="sthref216"></a></p>
<div class="tblformal"><a id="NTMTS213" name="NTMTS213"></a><a id="sthref217" name="sthref217"></a><a id="g1020792" name="g1020792"></a>
<p class="titleintable">Table 4-6 OraMTSEnlCtxGet() Parameters</p>
<table class="Formal" title="OraMTSEnlCtxGet() Parameters" summary="OraMTSEnlCtxGet() parameters. Column 1 lists the parameter, column 2 indicates if the parameter has an IN or OUT binding, and column 3 contains a description of the parameter." dir="ltr" border="1" width="100%" frame="hsides" rules="groups" cellpadding="3" cellspacing="0">
<col width="13%" />
<col width="11%" />
<col width="*" />
<thead>
<tr align="left" valign="top">
<th align="left" valign="bottom" id="r1c1-t8">Parameter</th>
<th align="left" valign="bottom" id="r1c2-t8">IN/OUT</th>
<th align="left" valign="bottom" id="r1c3-t8">Description</th>
</tr>
</thead>
<tbody>
<tr align="left" valign="top">
<td align="left" id="r2c1-t8" headers="r1c1-t8">
<p><code>lpUname</code></p>
</td>
<td align="left" headers="r2c1-t8 r1c2-t8">
<p><code>IN</code></p>
</td>
<td align="left" headers="r2c1-t8 r1c3-t8">
<p>Username for connecting to the Oracle Database</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r3c1-t8" headers="r1c1-t8">
<p><code>lpPsswd</code></p>
</td>
<td align="left" headers="r3c1-t8 r1c2-t8">
<p><code>IN</code></p>
</td>
<td align="left" headers="r3c1-t8 r1c3-t8">
<p>Password for connecting to the Oracle Database</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r4c1-t8" headers="r1c1-t8">
<p><code>lpDbnam</code></p>
</td>
<td align="left" headers="r4c1-t8 r1c2-t8">
<p><code>IN</code></p>
</td>
<td align="left" headers="r4c1-t8 r1c3-t8">
<p>Net service name for connecting to a database</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r5c1-t8" headers="r1c1-t8">
<p><code>pOCISvc</code></p>
</td>
<td align="left" headers="r5c1-t8 r1c2-t8">
<p><code>IN</code></p>
</td>
<td align="left" headers="r5c1-t8 r1c3-t8">
<p>OCI service context for a nonpooled connection</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r6c1-t8" headers="r1c1-t8">
<p><code>pOCIErr</code></p>
</td>
<td align="left" headers="r6c1-t8 r1c2-t8">
<p><code>IN</code></p>
</td>
<td align="left" headers="r6c1-t8 r1c3-t8">
<p>OCI error handle</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r7c1-t8" headers="r1c1-t8">
<p><code>dwFlags</code></p>
</td>
<td align="left" headers="r7c1-t8 r1c2-t8">
<p><code>IN</code></p>
</td>
<td align="left" headers="r7c1-t8 r1c3-t8">
<p>Enlistment flags. The only value currently permitted is <code>0</code>.</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r8c1-t8" headers="r1c1-t8">
<p><code>pCtxt</code></p>
</td>
<td align="left" headers="r8c1-t8 r1c2-t8">
<p><code>OUT</code></p>
</td>
<td align="left" headers="r8c1-t8 r1c3-t8">
<p>Enlistment context to be created</p>
</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="tblformal" -->
<a id="NTMTS214" name="NTMTS214"></a>
<p class="subhead2">Returns</p>
<p>Returns <code>ORAMTSERR_NOERROR</code> on success.</p>
<a id="NTMTS215" name="NTMTS215"></a>
<p class="subhead2">Usage Notes</p>
<ul>
<li>
<p>This call sets up an enlistment context for a nonpooled connection. This call must be started just after the caller establishes the OCI connection to the database. Once created, this context can be passed into <code>OraMTSJoinTxn()</code> calls. Prior to deleting the OCI connection, <code>OraMTSEnlCtxRel()</code> must be called to delete the enlistment context.</p>
</li>
<li>
<p>Callers must:</p>
<ul>
<li>
<p>Allocate a nonpooled connection through OCI.</p>
</li>
<li>
<p>Create an enlistment context by calling <code>OraMTSEnlCtxGet()</code>.</p>
</li>
<li>
<p>Enlist the connection by calling <code>OraMTSJoinTxn()</code>.</p>
</li>
<li>
<p>Perform database work.</p>
</li>
<li>
<p>De-enlist the connection by calling <code>OraMTSJoinTxn()</code> with a <code>NULL</code> transaction pointer.</p>
</li>
<li>
<p>Attempt to commit or terminate work.</p>
</li>
<li>
<p>Release the enlistment context by calling <code>OraMTSEnlCtxRel()</code>.</p>
</li>
<li>
<p>Release the nonpooled OCI connection and delete its associated OCI environment handle.</p>
</li>
</ul>
</li>
</ul>
</div>
<!-- class="sect2" -->
<a id="i1007218" name="i1007218"></a><a id="NTMTS216" name="NTMTS216"></a>
<div class="sect2">
<h3 class="sect2">OraMTSEnlCtxRel()<a id="sthref218" name="sthref218"></a></h3>
<p>Eliminates a previously set up enlistment context for a nonpooled OCI connection.</p>
<a id="NTMTS217" name="NTMTS217"></a>
<p class="subhead2">Syntax<a id="sthref219" name="sthref219"></a></p>
<pre xml:space="preserve" class="oac_no_warn">DWORD OraMTSEnlCtxRel(void* pCtxt); 
</pre>
<a id="NTMTS218" name="NTMTS218"></a>
<p class="subhead2">Parameters<a id="sthref220" name="sthref220"></a></p>
<div class="tblformal"><a id="NTMTS219" name="NTMTS219"></a><a id="sthref221" name="sthref221"></a><a id="g1021387" name="g1021387"></a>
<p class="titleintable">Table 4-7 OraMTSEnlCtxRel() Parameters</p>
<table class="Formal" title="OraMTSEnlCtxRel() Parameters" summary="OraMTSEnlCtxRel() parameters. Column 1 lists the parameter, column 2 indicates if the parameter has an IN or OUT binding, and column 3 contains a description of the parameter." dir="ltr" border="1" width="100%" frame="hsides" rules="groups" cellpadding="3" cellspacing="0">
<col width="13%" />
<col width="13%" />
<col width="*" />
<thead>
<tr align="left" valign="top">
<th align="left" valign="bottom" id="r1c1-t9">Parameter</th>
<th align="left" valign="bottom" id="r1c2-t9">IN/OUT</th>
<th align="left" valign="bottom" id="r1c3-t9">Description</th>
</tr>
</thead>
<tbody>
<tr align="left" valign="top">
<td align="left" id="r2c1-t9" headers="r1c1-t9">
<p><code>pCtxt</code></p>
</td>
<td align="left" headers="r2c1-t9 r1c2-t9">
<pre xml:space="preserve" class="oac_no_warn">IN
</pre></td>
<td align="left" headers="r2c1-t9 r1c3-t9">
<p>Enlistment context to eliminate</p>
</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="tblformal" -->
<a id="NTMTS220" name="NTMTS220"></a>
<p class="subhead2">Returns<a id="sthref222" name="sthref222"></a></p>
<p>Returns <code>ORAMTSERR_NOERROR</code> on success.</p>
<a id="NTMTS221" name="NTMTS221"></a>
<p class="subhead2">Usage Notes</p>
<ul>
<li>
<p>Before dropping a nonpooled OCI connection, a client must call <code>OraMTSEnlCtxRel()</code> to eliminate any enlistment context it may have created for that connection. The enlistment context can maintain OCI handles allocated off the connection's OCI environment handle. This makes it imperative that the environment handle is not deleted for the associated enlistment context.</p>
</li>
</ul>
</div>
<!-- class="sect2" -->
<a id="i1007259" name="i1007259"></a><a id="NTMTS222" name="NTMTS222"></a>
<div class="sect2">
<h3 class="sect2"><a id="sthref223" name="sthref223"></a>OraMTSJoinTxn() <a id="sthref224" name="sthref224"></a><a id="sthref225" name="sthref225"></a><a id="sthref226" name="sthref226"></a></h3>
<p>Enlists a nonpooled OCI connection in an MS DTC transaction.</p>
<a id="NTMTS223" name="NTMTS223"></a>
<p class="subhead2">Syntax<a id="sthref227" name="sthref227"></a></p>
<pre xml:space="preserve" class="oac_no_warn">DWORD OraMTSJoinTxn(void*  pCtxt, 
                    void*  pTrans);
</pre>
<a id="NTMTS224" name="NTMTS224"></a>
<p class="subhead2">Parameters</p>
<div class="tblformal"><a id="NTMTS225" name="NTMTS225"></a><a id="sthref228" name="sthref228"></a><a id="g1021533" name="g1021533"></a>
<p class="titleintable">Table 4-8 OraMTSJoinTxn() Parameters</p>
<table class="Formal" title="OraMTSJoinTxn() Parameters" summary="OraMTSJoinTxn() parameters. Column 1 lists the parameter, column 2 indicates if the parameter has an IN or OUT binding, and column 3 contains a description of the parameter." dir="ltr" border="1" width="100%" frame="hsides" rules="groups" cellpadding="3" cellspacing="0">
<col width="23%" />
<col width="23%" />
<col width="*" />
<thead>
<tr align="left" valign="top">
<th align="left" valign="bottom" id="r1c1-t10">Parameter</th>
<th align="left" valign="bottom" id="r1c2-t10">IN</th>
<th align="left" valign="bottom" id="r1c3-t10">Description</th>
</tr>
</thead>
<tbody>
<tr align="left" valign="top">
<td align="left" id="r2c1-t10" headers="r1c1-t10">
<p><code>pCtxt</code></p>
</td>
<td align="left" headers="r2c1-t10 r1c2-t10">
<p><code>IN</code></p>
</td>
<td align="left" headers="r2c1-t10 r1c3-t10">
<p>Enlistment context for the OCI connection</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r3c1-t10" headers="r1c1-t10">
<p><code>pTrans</code></p>
</td>
<td align="left" headers="r3c1-t10 r1c2-t10">
<p><code>IN</code></p>
</td>
<td align="left" headers="r3c1-t10 r1c3-t10">
<p>Reference to the MS DTC transaction object</p>
</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="tblformal" -->
<a id="NTMTS226" name="NTMTS226"></a>
<p class="subhead2">Returns<a id="sthref229" name="sthref229"></a><a id="sthref230" name="sthref230"></a></p>
<p>Returns <code>ORAMTSERR_NOERROR</code> on success.</p>
<a id="NTMTS227" name="NTMTS227"></a>
<p class="subhead2">Usage Notes</p>
<ul>
<li>
<p>Clients use this call with nonpooled OCI connections to enlist connections in MS DTC-coordinated transactions. The client passes in the wide reference to the enlistment context representing the OCI connection, along with a reference to an MS DTC transaction object. If <code>pTrans</code> is <code>NULL</code>, the OCI connection is de-enlisted from any MS DTC transaction in which it is currently enlisted. You can enlist a previously-enlisted OCI connection in a different MS DTC transaction.</p>
</li>
</ul>
</div>
<!-- class="sect2" -->
<a id="i1007305" name="i1007305"></a><a id="NTMTS228" name="NTMTS228"></a>
<div class="sect2">
<h3 class="sect2">OraMTSTransTest()</h3>
<p>Tests if you are running inside a Microsoft Transaction Server-started transaction.</p>
<a id="NTMTS229" name="NTMTS229"></a>
<p class="subhead2">Syntax<a id="sthref231" name="sthref231"></a></p>
<pre xml:space="preserve" class="oac_no_warn">BOOL OraMTSTransTest();
</pre>
<a id="NTMTS230" name="NTMTS230"></a>
<p class="subhead2">Returns</p>
<p>Returns <code>true</code> if running inside a Microsoft Transaction Server transaction.</p>
<a id="NTMTS231" name="NTMTS231"></a>
<p class="subhead2">Usage Notes</p>
<p>Microsoft Transaction Server transactional components use <code>OraMTSTransTest()</code> to check if a component is running within the context of a Microsoft Transaction Server transaction. Note that this call can only test Microsoft Transaction Server-started transactions. Transactions started by directly calling the MS DTC are not detected.</p>
</div>
<!-- class="sect2" -->
<a id="i1007335" name="i1007335"></a><a id="NTMTS232" name="NTMTS232"></a>
<div class="sect2">
<h3 class="sect2">OraMTSOCIErrGet() <a id="sthref232" name="sthref232"></a><a id="sthref233" name="sthref233"></a></h3>
<p>Retrieves the OCI error code and message text, if any, from the last <code>OraMTS</code> function operation, typically <code>OraMTSSvcGet()</code> or <code>OraMTSJoinTxn()</code>.</p>
<a id="NTMTS233" name="NTMTS233"></a>
<p class="subhead2">Syntax<a id="sthref234" name="sthref234"></a></p>
<pre xml:space="preserve" class="oac_no_warn">BOOL OraMTSOCIErrGet(DWORD* dwErr, 
                     LPCHAR lpcEMsg, 
                     DWORD* lpdLen);
</pre>
<a id="NTMTS234" name="NTMTS234"></a>
<p class="subhead2">Parameters<a id="sthref235" name="sthref235"></a><a id="sthref236" name="sthref236"></a></p>
<div class="tblformal"><a id="NTMTS235" name="NTMTS235"></a><a id="sthref237" name="sthref237"></a><a id="CEGHGCBG" name="CEGHGCBG"></a>
<p class="titleintable">Table 4-9 OraMTSOCIErrGet() Parameters</p>
<table class="Formal" title="OraMTSOCIErrGet() Parameters" summary="OraMTSOCIErrGet() parameters. Column 1 lists the parameter, column 2 indicates if the parameter has an IN or OUT binding, and column 3 contains a description of the parameter." dir="ltr" border="1" width="100%" frame="hsides" rules="groups" cellpadding="3" cellspacing="0">
<col width="14%" />
<col width="10%" />
<col width="*" />
<thead>
<tr align="left" valign="top">
<th align="left" valign="bottom" id="r1c1-t11">Parameter</th>
<th align="left" valign="bottom" id="r1c2-t11">IN/OUT</th>
<th align="left" valign="bottom" id="r1c3-t11">Description</th>
</tr>
</thead>
<tbody>
<tr align="left" valign="top">
<td align="left" id="r2c1-t11" headers="r1c1-t11">
<p><code>dwErr</code></p>
</td>
<td align="left" headers="r2c1-t11 r1c2-t11">
<p><code>-</code></p>
</td>
<td align="left" headers="r2c1-t11 r1c3-t11">
<p>Error code</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r3c1-t11" headers="r1c1-t11">
<p><code>lpcEMsg</code></p>
</td>
<td align="left" headers="r3c1-t11 r1c2-t11">
<p><code>-</code></p>
</td>
<td align="left" headers="r3c1-t11 r1c3-t11">
<p>Buffer for the error message, if any</p>
</td>
</tr>
<tr align="left" valign="top">
<td align="left" id="r4c1-t11" headers="r1c1-t11">
<p><code>lpdLen</code></p>
</td>
<td align="left" headers="r4c1-t11 r1c2-t11">
<p><code>-</code></p>
</td>
<td align="left" headers="r4c1-t11 r1c3-t11">
<p>Set to the actual number of message bytes</p>
</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="tblformal" -->
<a id="NTMTS236" name="NTMTS236"></a>
<p class="subhead2">Returns</p>
<p>Returns <code>true</code> if an OCI error is encountered. Otherwise, <code>false</code> is returned. If <code>true</code> is returned and <code>lpcEMsg</code> and <code>lpdLen</code> are valid, and there is a stashed error message, up to <code>lpdLen</code> bytes are copied into <code>lpcEMsg</code>. <code>lpdLen</code> is set to the actual number of message bytes.</p>
<a id="NTMTS237" name="NTMTS237"></a>
<p class="subhead2">Usage Notes</p>
<p><a href="#BEJEFACA">Example 4-2</a> illustrates how <code>OraMTSOCIErrGet()</code> retrieves the OCI error code and OCI error message text, if any, from the last <code>OraMTSSvc()</code> operation on this thread.</p>
<div class="example"><a id="BEJEFACA" name="BEJEFACA"></a><a id="NTMTS238" name="NTMTS238"></a>
<p class="titleinexample">Example 4-2 Retrieving the OCI Error Code and Message Text</p>
<pre xml:space="preserve" class="oac_no_warn">DWORD dwStat = OraMTSSvcGet("hr",
                            "invalid_password",
                            "fin_prod",
                            "db",
                            &amp;mysvch,
                            &amp;myenvh, 
                            ORAMTS_CFLG_ALLDEFAULT);

if (dwStat != ORAMTS_ERR_NOERROR)
   {
      DWORD   dwOCIErr;
      char    errBuf[MAX_PATH];
      DWORD   errBufLen = sizeof(effBuf);

      if (OraMTSOCIErrGet(&amp;dwOCIErr, &amp;errBuf, &amp;errBufLen))
            printf("OCIError %d: %s"\n);
   }
</pre></div>
<!-- class="example" --></div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i1007399" name="i1007399"></a><a id="NTMTS239" name="NTMTS239"></a>
<div class="sect1">
<h2 class="sect1">ODBC Integration with Microsoft Transaction Server Overview<a id="sthref238" name="sthref238"></a><a id="sthref239" name="sthref239"></a><a id="sthref240" name="sthref240"></a></h2>
<p>This section describes how to use Oracle ODBC Driver with Microsoft Transaction Server and a Oracle Database. No changes to OCI code are necessary for ODBC to operate successfully.</p>
<a id="CEGBEJGA" name="CEGBEJGA"></a><a id="NTMTS240" name="NTMTS240"></a>
<div class="sect2">
<h3 class="sect2">Setting the Connection Attribute<a id="sthref241" name="sthref241"></a><a id="sthref242" name="sthref242"></a><a id="sthref243" name="sthref243"></a><a id="sthref244" name="sthref244"></a></h3>
<p>To use Microsoft Transaction Server with either Oracle ODBC Driver 11.1 or Microsoft Oracle ODBC driver, set the connection attribute using the <code>SQLSetConnectAttr</code> function to call the parameter <code>SQL_ATTR_ENLIST_IN_DTC</code> in the ODBC code. This enables you to receive connection pooling and implicit transaction support.</p>
</div>
<!-- class="sect2" -->
<a id="i1007447" name="i1007447"></a><a id="NTMTS241" name="NTMTS241"></a>
<div class="sect2">
<h3 class="sect2">Using Oracle ODBC Driver<a id="sthref245" name="sthref245"></a><a id="sthref246" name="sthref246"></a><a id="sthref247" name="sthref247"></a></h3>
<p>The ODBC Driver Manager distributed with ODBC 3.0 is a Resource Dispenser that supports connection pooling. Oracle ODBC Driver release 11.1 integrates with the ODBC 3.0 Driver Manager by supporting the <code>SQLSetConnectAttr(...,..., SQL_ATTR_ENLIST_IN_DTC)</code> call to enlist or de-enlist the ODBC connection used in MS DTC-coordinated transactions.</p>
<p>Use the Oracle ODBC Driver 11.1 with:</p>
<ul>
<li>
<p>Applications you develop</p>
</li>
<li>
<p>The sample banking application that Microsoft provides with Microsoft Transaction Server.</p>
</li>
</ul>
<p>To configure Oracle ODBC Driver, follow these steps:<a id="sthref248" name="sthref248"></a></p>
<ol>
<li>
<p>Choose <span class="bold">Start</span> &gt; <span class="bold">Settings</span> &gt; <span class="bold">Control Panel</span>.</p>
<p>The Control Panel window appears.</p>
</li>
<li>
<p>Double-click <span class="bold">ODBC</span>.</p>
<p>The ODBC Data Source Administrator dialog box appears.</p>
</li>
<li>
<p>Choose the <span class="bold">File DSN</span> tab.</p>
</li>
<li><a id="BEJJDHDA" name="BEJJDHDA"></a>
<p>To make Oracle ODBC Driver work with Microsoft sample banking application demo, follow these steps. Otherwise, skip this step.</p>
<ul>
<li>
<p>Back up Microsoft <code>mtssamples.dsn</code> file. This file is located in <code><span class="codeinlineitalic">ROOTDRIVE</span></code>:\<code>program files\common files\odbc\data sources</code>.</p>
</li>
<li><a id="i1007495" name="i1007495"></a>
<p>Select <a id="sthref249" name="sthref249"></a><a id="sthref250" name="sthref250"></a><code>mtssamples.dsn</code> and click <span class="bold">Remove</span>.</p>
</li>
<li><a id="i1007498" name="i1007498"></a>
<p>Click <span class="bold">Yes</span> when prompted.</p>
<p>This deletes the configuration file that enables the Microsoft Transaction Server sample application demo to use the Microsoft ODBC driver.</p>
</li>
</ul>
<p>If you don't intend to use the demo, click <span class="bold">Add to create a new File data source name (DSN)</span>.</p>
<p>The Create New Data Source wizard appears.</p>
</li>
<li>
<p>Select <span class="bold">Oracle</span> in <code><span class="codeinlineitalic">HOME_NAME</span></code>.</p>
</li>
<li>
<p>Click <span class="bold">Advanced</span>.</p>
</li>
<li>
<p>Add the following information in the keywords and values field:</p>
<pre xml:space="preserve" class="oac_no_warn">SERVER=<span class="italic">database_alias</span>
USERNAME=hr 
PASSWORD=<span class="italic">hr_password</span>
</pre>
<p>where:</p>
<ul>
<li>
<p><code>SERVER</code> is the The database alias used by the demo to access the database <code>mtsdemo</code>.</p>
</li>
<li>
<p><code>USERNAME</code> is the database username for this application, such as <code>hr</code>.</p>
</li>
<li>
<p><code>PASSWORD</code> is the database password for username <code>hr</code>.</p>
</li>
</ul>
<p>Verify that the <code>hr</code> schema contains the <code>account</code> and <code>receipt</code> tables.</p>
</li>
<li>
<p>Click <span class="bold">OK</span>.</p>
</li>
<li>
<p>Click <span class="bold">Next</span> to continue with the Create New Data Source wizard.</p>
</li>
<li>
<p>For the Microsoft sample application, enter <code>mtssamples.dsn</code> (Microsoft ODBC name). This name must exactly match the name you removed in Step <a href="#BEJJDHDA">4</a>.</p>
<p>For applications you develop, enter the name of the DSN file that will be used.</p>
</li>
<li>
<p>Complete the remaining Create New Data Source wizard pages.</p>
</li>
<li>
<p>Click <span class="bold">OK</span> to exit the ODBC Data Source Administrator dialog box.</p>
</li>
<li>
<p>Exit the Control Panel window.</p>
</li>
</ol>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<p>Microsoft Transaction Server SDK for information</p>
</div>
</div>
<!-- class="sect2" -->
<a id="i1007575" name="i1007575"></a><a id="NTMTS242" name="NTMTS242"></a>
<div class="sect2">
<h3 class="sect2">Using Microsoft Oracle ODBC Driver<a id="sthref251" name="sthref251"></a><a id="sthref252" name="sthref252"></a><a id="sthref253" name="sthref253"></a></h3>
<p>As an alternative to the Oracle ODBC driver, you can use the Microsoft Oracle ODBC Driver. You should be aware that you would not be able to integrate with OO4O, Oracle Provider for OLE DB, and Oracle Data Provider for .NET if using the Microsoft driver. Also, you will not receive the performance benefits of the Oracle ODBC driver, API support for integration, or Oracle client support services.</p>
<p>After enabling the Microsoft Oracle ODBC Driver, perform these additional steps to configure the Microsoft Oracle ODBC Driver:</p>
<p>To configure the Microsoft Oracle ODBC Driver:<a id="sthref254" name="sthref254"></a><a id="sthref255" name="sthref255"></a></p>
<ol>
<li>
<p>Install Oracle Required Support Files (RSF) and SQL*Net 2.3 or later on the computer where the Microsoft Oracle ODBC Driver is operating.</p>
</li>
<li>
<p>Run the <code><span class="codeinlineitalic">ORACLE_BASE</span></code><code>\</code><code><span class="codeinlineitalic">ORACLE_HOME</span></code>\<code>oramts\samples\ sql\omtssamp.sql</code> script.</p>
</li>
<li>
<p>Use SQL*Net Easy Config to set up a database alias connection. This alias is used in the <code>mtssamples.dsn</code> file.</p>
</li>
<li>
<p>If you installed the RSFs in a home with Oracle Net installed, be sure to set the following registry parameter at <code>HKEY_LOCAL_MACHINE\SOFTWARE\ORACLE</code>:<a id="sthref256" name="sthref256"></a></p>
<pre xml:space="preserve" class="oac_no_warn">ORAOCI = ORA73.DLL
</pre></li>
</ol>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
"Setting Up MTS to Access Oracle" in the Microsoft Transaction Server online Help for instructions on enabling the Microsoft Oracle ODBC Driver</div>
</div>
<!-- class="sect2" --></div>
<!-- class="sect1" --></div>
<!-- class="ind" -->
<div class="footer">
<hr />
<table class="simple oac_no_warn" summary="" cellspacing="0" cellpadding="0" width="100%">
<col width="33%" />
<col width="*" />
<col width="33%" />
<tr>
<td align="left">
<table class="simple oac_no_warn" summary="" cellspacing="0" cellpadding="0" width="98">
<tr>
<td align="center" valign="top"><a href="recovery.htm"><img width="24" height="24" src="../../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td align="center" valign="top"><a href="perftune.htm"><img width="24" height="24" src="../../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td style="font-size: 90%" align="center" class="copyrightlogo"><img width="144" height="18" src="../../dcommon/gifs/oracle.gif" alt="Oracle" /><br />
Copyright&nbsp;&copy;&nbsp;1996, 2010,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.<br />
<a href="../../dcommon/html/cpyr.htm">Legal Notices</a></td>
<td align="right">
<table class="icons oac_no_warn" summary="" cellspacing="0" cellpadding="0" width="245">
<tr>
<td align="center" valign="top"><a href="../../index.htm"><img width="24" height="24" src="../../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td align="center" valign="top"><a href="../../nav/portal_booklist.htm"><img width="24" height="24" src="../../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td align="center" valign="top"><a href="toc.htm"><img width="24" height="24" src="../../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td align="center" valign="top"><a href="index.htm"><img width="24" height="24" src="../../dcommon/gifs/index.gif" alt="Go to Index" /><br />
<span class="icon">Index</span></a></td>
<td align="center" valign="top"><a href="../../dcommon/html/feedback.htm"><img width="24" height="24" src="../../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
</div>
<noscript>
<p>Scripting on this page enhances content navigation, but does not change the content in any way.</p>
</noscript>
</body>
</html>
